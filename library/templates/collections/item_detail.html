{% extends 'base.html' %}
{% load static %}

<div class="hero-image">
    {% block hero_image %}
        <img src="{% static 'images/candle-inscription-books-compass.jpg' %}" alt="Nav Image">
        <div class="hero-text">
            <div class="hero-button" id="scroll-button">ABOUT THE ITEM<i class="fas fa-arrow-down down-arrow"></i></div>
        </div>
    {% endblock %}
</div>

{% block main_content %}
<section class="item-details-page">
    <div class="item-details-container">
        <div class="item-details-cover">
            <img src="{{ object.item_image.url }}" alt="Cover Image" />
        </div>

        <div class="item-details-info">
            <h2 class="item-details-title">{{ object.title }}</h2>
            <div class="item-details-description">
                <strong>Author:</strong> {{ object.author.name }}<br>
                <strong>Genre:</strong> {{ object.genre }}<br>
                <strong>Publication Date:</strong> {{ object.publication_date|date:"F j, Y" }}<br>
                <strong>ISBN:</strong> {{ object.isbn }}<br>
            </div>

            <div class="item-details-action-buttons">
                <a href="#" id="open-sample-btn" class="item-details-sample-btn">READ A SAMPLE</a>
                
                <div class="admin-action-buttons">
                    {% if user.is_superuser or user.is_staff %}
                        <a href="{% url 'item edit' pk=object.pk slug=object.slug %}" class="item-details-edit">Edit</a>
                        <a href="#" id="delete-item-btn" class="item-details-remove">Delete</a>                
                    {% endif %}
                </div>

                <button id="save-item-btn" data-item-id="{{ object.id }}" class="save-profile-btn">
                    <span class="save-text">
                        {% if object in request.user.libraryprofile.saved_items.all %}
                            SAVED
                        {% else %}
                            SAVE TO PROFILE
                        {% endif %}
                    </span>
                    <span class="heart-icon">
                        {% if object in request.user.libraryprofile.saved_items.all %}
                            ‚ù§Ô∏è
                        {% else %}
                            ü§ç
                        {% endif %}
                    </span>
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Sample Modal with Pagination -->
<div id="sample-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>{{ object.title }} - Sample</h2>
        <div class="sample-text" id="sample-text-container">
            <!-- Sample text pages will be inserted here -->
        </div>
        <div class="pagination-controls">
            <button id="prev-page-btn" class="prev-page" disabled>Previous</button>
            <span id="current-page">Page 1</span>
            <button id="next-page-btn" class="next-page">Next</button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Delete {{ object.title }}?</h2>
        <p>Are you sure you want to delete this item?</p>
        <div class="delete-action-buttons">
            <button id="confirm-delete-btn" class="confirm-delete">Yes, Delete</button>
            <button id="cancel-delete-btn" class="cancel-delete">Cancel</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const sampleModal = document.getElementById("sample-modal");
        const openSampleBtn = document.getElementById("open-sample-btn");
        const closeBtns = document.getElementsByClassName("close-btn");
        const sampleTextContainer = document.getElementById("sample-text-container");
        const sampleText = `{{ object.sample|escapejs }}`; // Escape the sample text for JavaScript
        const pageSize = 500; // Adjust the number of characters per page as needed
        let pages = [];
        let currentPage = 0;

        // Split the sample text into pages
        function paginateSampleText(text, pageSize) {
            let words = text.split(' ');
            let pagesArray = [];
            let currentPageText = '';

            words.forEach(word => {
                if ((currentPageText + word + ' ').length > pageSize) {
                    pagesArray.push(currentPageText.trim());
                    currentPageText = word + ' ';
                } else {
                    currentPageText += word + ' ';
                }
            });

            if (currentPageText.trim().length > 0) {
                pagesArray.push(currentPageText.trim());
            }

            return pagesArray;
        }
        
        function updateSampleText() {
            sampleTextContainer.innerHTML = `<p>${pages[currentPage]}</p>`;
            document.getElementById("current-page").textContent = `Page ${currentPage + 1} of ${pages.length}`;
            document.getElementById("prev-page-btn").disabled = currentPage === 0;
            document.getElementById("next-page-btn").disabled = currentPage === pages.length - 1;
        }

        function openSampleModal(event) {
            event.preventDefault();
            pages = paginateSampleText(sampleText, pageSize);
            currentPage = 0;
            updateSampleText();
            openModal(sampleModal);
        }

        document.getElementById("prev-page-btn").addEventListener("click", function() {
            if (currentPage > 0) {
                currentPage--;
                updateSampleText();
            }
        });

        document.getElementById("next-page-btn").addEventListener("click", function() {
            if (currentPage < pages.length - 1) {
                currentPage++;
                updateSampleText();
            }
        });

        openSampleBtn.addEventListener("click", openSampleModal);

        // Close modal functionality
        for (const closeBtn of closeBtns) {
            closeBtn.onclick = function() {
                sampleModal.style.display = "none";
                document.getElementById("delete-modal").style.display = "none"; // Ensure delete modal closes
            };
        }

        document.getElementById("delete-item-btn").addEventListener("click", function() {
            document.getElementById("delete-modal").style.display = "block";
        });

        document.getElementById("confirm-delete-btn").addEventListener("click", function() {
            sampleModal.style.display = "none";
        });

        document.getElementById("cancel-delete-btn").addEventListener("click", function() {
            document.getElementById("delete-modal").style.display = "none"; // Close the delete modal
        });
    });

    // Function to open a modal
    function openModal(modal) {
        modal.style.display = "block";
    }

    // Close modal on window click
    window.onclick = function(event) {
        const modals = document.getElementsByClassName("modal");
        for (let i = 0; i < modals.length; i++) {
            if (event.target === modals[i]) {
                modals[i].style.display = "none";
            }
        }
    };
</script>
    
<script>
    document.getElementById('save-item-btn').addEventListener('click', function(event) {
        const itemId = this.getAttribute('data-item-id');
        const itemSlug = '{{ object.slug }}'; 
        const saveText = this.querySelector('.save-text');

        fetch(`/collections/${itemId}/${itemSlug}/save_item/`, { 
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ item_id: itemId })
        })
        .then(response => response.json())
        .then(data => {
            const heartIcon = this.querySelector('.heart-icon');

            if (data.favorited) {
                heartIcon.innerHTML = '‚ù§Ô∏è'; 
                saveText.innerHTML = 'SAVED';
            } else {
                heartIcon.innerHTML = 'ü§ç'; 
                saveText.innerHTML = 'SAVE TO PROFILE';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>
{% endblock %}
